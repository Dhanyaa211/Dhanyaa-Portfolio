<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Dashboard - Portfolio</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">üìß Contact Dashboard</h1>
            
            <!-- Server Status -->
            <div id="status" class="mb-6 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-2">Server Status</h2>
                <div id="statusContent">Checking server status...</div>
            </div>

            <!-- Contacts Table -->
            <div id="contactsSection">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">Recent Contacts</h2>
                    <button onclick="loadContacts()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        üîÑ Refresh
                    </button>
                </div>
                
                <div id="contactsTable" class="overflow-x-auto">
                    <div class="text-center py-8">Loading contacts...</div>
                </div>

                <!-- Pagination -->
                <div id="pagination" class="mt-6 flex justify-center space-x-2"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';
        let currentPage = 1;

        // Check server status
        async function checkStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                document.getElementById('status').className = 'mb-6 p-4 rounded-lg bg-green-100 border border-green-300';
                document.getElementById('statusContent').innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="text-green-600">‚úÖ ${data.status}</span>
                        <span class="text-sm text-gray-600">Database: ${data.database}</span>
                        <span class="text-sm text-gray-500">${new Date(data.timestamp).toLocaleString()}</span>
                    </div>
                `;
            } catch (error) {
                document.getElementById('status').className = 'mb-6 p-4 rounded-lg bg-red-100 border border-red-300';
                document.getElementById('statusContent').innerHTML = `
                    <span class="text-red-600">‚ùå Server offline or unreachable</span>
                `;
            }
        }

        // Load contacts
        async function loadContacts(page = 1) {
            try {
                const response = await fetch(`${API_BASE}/contacts?page=${page}&limit=10`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message);
                }

                renderContactsTable(data.contacts);
                renderPagination(data.pagination);
                currentPage = page;
            } catch (error) {
                document.getElementById('contactsTable').innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        ‚ùå Error loading contacts: ${error.message}
                    </div>
                `;
            }
        }

        // Render contacts table
        function renderContactsTable(contacts) {
            if (contacts.length === 0) {
                document.getElementById('contactsTable').innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        üì≠ No contacts yet
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${contacts.map(contact => `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">${contact.name}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <a href="mailto:${contact.email}" class="text-sm text-blue-600 hover:text-blue-800">
                                        ${contact.email}
                                    </a>
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm text-gray-900 max-w-xs truncate" title="${contact.subject}">
                                        ${contact.subject}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-500">
                                        ${new Date(contact.createdAt).toLocaleDateString()}
                                        <div class="text-xs text-gray-400">
                                            ${new Date(contact.createdAt).toLocaleTimeString()}
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button onclick="viewContact('${contact._id}')" 
                                            class="text-blue-600 hover:text-blue-900 mr-3">
                                        üëÅÔ∏è View
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('contactsTable').innerHTML = tableHTML;
        }

        // Render pagination
        function renderPagination(pagination) {
            if (pagination.totalPages <= 1) {
                document.getElementById('pagination').innerHTML = '';
                return;
            }

            let paginationHTML = '';

            // Previous button
            if (pagination.hasPrev) {
                paginationHTML += `
                    <button onclick="loadContacts(${pagination.currentPage - 1})" 
                            class="px-3 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        ‚Üê Previous
                    </button>
                `;
            }

            // Page numbers
            for (let i = 1; i <= Math.min(pagination.totalPages, 5); i++) {
                const isActive = i === pagination.currentPage;
                paginationHTML += `
                    <button onclick="loadContacts(${i})" 
                            class="px-3 py-2 border rounded-md ${isActive 
                                ? 'bg-blue-500 text-white border-blue-500' 
                                : 'bg-white border-gray-300 hover:bg-gray-50'}">
                        ${i}
                    </button>
                `;
            }

            // Next button
            if (pagination.hasNext) {
                paginationHTML += `
                    <button onclick="loadContacts(${pagination.currentPage + 1})" 
                            class="px-3 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Next ‚Üí
                    </button>
                `;
            }

            // Stats
            paginationHTML += `
                <div class="px-3 py-2 text-sm text-gray-500">
                    Total: ${pagination.totalContacts} contacts
                </div>
            `;

            document.getElementById('pagination').innerHTML = paginationHTML;
        }

        // View individual contact
        async function viewContact(id) {
            try {
                const response = await fetch(`${API_BASE}/contacts/${id}`);
                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message);
                }

                const contact = data.contact;
                alert(`
Contact Details:

Name: ${contact.name}
Email: ${contact.email}
Subject: ${contact.subject}

Message:
${contact.message}

Submitted: ${new Date(contact.createdAt).toLocaleString()}
IP: ${contact.ipAddress || 'N/A'}
                `);
            } catch (error) {
                alert('Error loading contact details: ' + error.message);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkStatus();
            loadContacts();
        });
    </script>
</body>
</html>
